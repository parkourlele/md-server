## 后端项目

### 安装nest cli
```bash
# 本地安装nestjs/cli
npm i -g @nestjs/cli

```
### 创建项目
```bash
# 创建项目
nest new server
# 安装依赖 prisma
cd server
npm i prisma --save-dev
npm i @prisma/client
# 初始化prisma 生成prisma/schema.prisma文件和.env文件
npx prisma init

# 在.env文件配置数据库连接例如：
DATABASE_URL="mysql://root:888888@localhost:3306/md_project"
```

### 创建测试数据库
```js
CREATE DATABASE mydb

// 创建prisma模型 prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
model User {
  id    Int     @id   @default(autoincrement())
  name  String
}
// 执行迁移 生成migrations/文件夹执行记录
npx prisma migrate dev --name init
```

## NestJs 命令
```bash
#获取所有命令提示帮助
nest g -h
# 创建module
nest g module prisma module 简写 mo
# 创建service
nest g service prisma servive 简写 s
┌───────────────┬─────────────┬──────────────────────────────────────────────┐
    │ name          │ alias       │ description                                  │
    │ application   │ application │ Generate a new application workspace         │
    │ class         │ cl          │ Generate a new class                         │
    │ configuration │ config      │ Generate a CLI configuration file            │
    │ controller    │ co          │ Generate a controller declaration            │
    │ decorator     │ d           │ Generate a custom decorator                  │
    │ filter        │ f           │ Generate a filter declaration                │
    │ gateway       │ ga          │ Generate a gateway declaration               │
    │ guard         │ gu          │ Generate a guard declaration                 │
    │ interceptor   │ itc         │ Generate an interceptor declaration          │
    │ interface     │ itf         │ Generate an interface                        │
    │ library       │ lib         │ Generate a new library within a monorepo     │
    │ middleware    │ mi          │ Generate a middleware declaration            │
    │ module        │ mo          │ Generate a module declaration                │
    │ pipe          │ pi          │ Generate a pipe declaration                  │
    │ provider      │ pr          │ Generate a provider declaration              │
    │ resolver      │ r           │ Generate a GraphQL resolver declaration      │
    │ resource      │ res         │ Generate a new CRUD resource                 │
    │ service       │ s           │ Generate a service declaration               │
    │ sub-app       │ app         │ Generate a new application within a monorepo │
    └───────────────┴─────────────┴──────────────────────────────────────────────┘
```

## NestJs中接入Prisma
### 创建Prisma模块
```bash
nest g mo prisma
nest g s prisma
```
### 生成一个user模块
```bash
nest g res user #resource缩写选择REST API和CURD模板
```
### 启动项目
```bash
npm run start:dev
```

## 项目部署服务器上
```bash
#首次
1. 登录服务器创建项目要放的文件夹
ssh root:Ip 输入密码
mkdir var/
mkdir web/
2. 文件上传到服务器
方法一: 直接上传文件夹
scp -r ./server root@服务器IP:/var/web/
方法二： 通过git仓库克隆（后续更新方便）
git clone http://xxx.git server

#后续本地代码上传git后的操作步骤1、2、6
1. git pull拉取新代码
#如有新增包（npm install）

#先打包，生成dist/文件夹，使用pm2部署dist/main.js
2. npm run build 

#使用pm2部署 nest-server是取的别名，随便取，为了区分进程
3. pm2 start dist/main.js --name nest-server
pm2 save
pm2 startup#开机自启

#查看部署列表 显示online表示成功
4. pm2 list

#停止
5. pm2 stop nest-server

#重启
6.pm2 restart nest-server

#实时查看后端日志
7. pm2 logs nest-server

```
### .env Prisma连接数据库配置
- 通过git clone的项目因为配置了.gitignore没有.env文件，需要手动上传到server文件夹下

## 服务器数据库

## 测试后端项目运行
### 前提：阿里云安全组开放了当前端口；防火墙ufw没阻止；pm2进程正常

1. 确认服务运行
```bash
pm2 list #online
```
2. 确认端口是否监听
```bash
#端口号是后端main.ts中定义的默认3000
netstat -tlnp | grep 3000
```
3. 本地浏览器测试
http://ip:3000
http://ip:3000/user

### 常见问题
```bash
listen EADDRINUSE:adress already in use :::3000 # 端口已经被别的进程占用了
# 常见原因：PM2已经在跑了， 手动启动了npm run start:prod，导致端口冲突，关掉npm run start:prod 
```
### 服务器创建数据库
1. 安装mysql CentOs: yum install mysql-server -y; Ubuntu: apt install mysql-server -y
2. 创建mysql，导入表，测试接口
```bash
# 登录mysql
mysql -u -root -p
# 创建数据库 数据库名例如为mydb
CREATE DATABASE mydb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
# 进入服务器
ssh root@ip
# 导出本地表放到服务器上
# 导入sql到服务器数据库，注意执行这个命令的位置和下面路径相关
mysql -u root -p mydb < /var/www/server/mydb.sql
# 查看表
mysql -u root -p mydb
SHOW DATABASES; SHOW TABLES;
# 编辑服务器上后端项目的.env文件
vi .env 进入.env文件 -> i 编辑 -> esc结束编辑 + :wq 退出
# 重启PM2
pm2 restart nest-server
# 测试接口
http://ip:3001/user
```
### 注意：
- prisma上的数据库表名需要和服务器数据上的数据库名一样，包括大小写

